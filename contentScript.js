/**
 * Gitlab-Drawio integration
 *
 * A chrome extenion that integrates diagrams.net functionality into gitlab
 * by allowing you to draw in-editor images into diagrams.net and uploading
 * them right into gitlab's editor view
 *
 * @author Ashutosh Chaudhary <http://github.com/codeasashu>
 * @link https://github.com/codeasashu/gitlab-diagrams-chromeextn
 * @license GPL
 */
'use strict';

const drawIoUrl = 'https://www.draw.io/?embed=1&ui=atlas&spin=1&proto=json';
let iframe = null,
	modalDiv = null,
	drawioBtnId = null;

let svgIcon = `<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" width="40" height="40"><defs><path d="M38.29 40C34.64 40 5.37 40 1.71 40C0.74 40 0 39.21 0 38.29C0 34.63 0 5.37 0 1.71C0 0.74 0.79 0 1.71 0C5.37 0 34.63 0 38.29 0C39.26 0 40 0.79 40 1.71C40 4.15 40 16.34 40 38.29C39.47 39.43 38.9 40 38.29 40Z" id="b4JGhtaG"></path><path d="M27.78 23.27C25.37 19.31 24.03 17.11 23.76 16.66C24.66 16.49 25.33 15.71 25.33 14.81C25.33 14.31 25.33 10.32 25.33 9.82C25.33 8.76 24.46 7.92 23.36 7.92C22.69 7.92 17.33 7.92 16.66 7.92C15.57 7.92 14.69 8.76 14.69 9.82C14.69 10.32 14.69 14.31 14.69 14.81C14.69 15.74 15.36 16.49 16.24 16.66C15.97 17.11 14.63 19.32 12.21 23.29C9.94 23.29 8.67 23.29 8.42 23.29C7.32 23.29 6.45 24.13 6.45 25.19C6.45 25.69 6.45 29.68 6.45 30.18C6.45 31.24 7.32 32.08 8.42 32.08C9.09 32.08 14.45 32.08 15.12 32.08C16.21 32.08 17.08 31.24 17.08 30.18C17.08 29.68 17.08 25.69 17.08 25.19C17.08 24.13 16.21 23.29 15.12 23.29C15.07 23.29 14.86 23.29 14.47 23.29L18.45 16.73L21.55 16.73L25.55 23.29C25.15 23.29 24.93 23.29 24.88 23.29C23.79 23.29 22.92 24.13 22.92 25.19C22.92 25.69 22.92 29.68 22.92 30.18C22.92 31.24 23.79 32.08 24.88 32.08C25.55 32.08 30.91 32.08 31.58 32.08C32.68 32.08 33.55 31.24 33.55 30.18C33.55 29.68 33.55 25.69 33.55 25.19C33.55 24.13 32.68 23.27 31.58 23.27C31.08 23.27 29.81 23.27 27.78 23.27Z" id="a56pjqCsSe"></path><path d="M375.84 642.74L375.84 642.73L375.84 642.7L375.84 642.67L375.84 642.64L375.84 642.59L375.84 642.55L375.84 642.49L375.84 642.43L375.84 642.36L375.84 642.29L375.84 642.22L375.84 642.13L375.84 642.05L375.84 641.95L375.84 641.86L375.84 641.76L375.84 641.65L375.84 641.54L375.84 641.42L375.84 641.3L375.84 641.18L375.84 641.05L375.84 640.92L375.84 640.79L375.84 640.65L375.84 640.51L375.84 640.36L375.84 640.21L375.84 640.06L375.84 639.91L375.84 639.75L375.84 639.59L375.84 639.43L375.84 639.27L375.84 639.1L375.84 638.93L375.84 638.76L375.84 638.59L375.84 627.78L375.84 627.5L375.84 626.79L375.84 626L375.84 625.14L375.84 624.21L375.84 624.13L375.84 629.75L375.84 629.84L375.84 629.92L375.84 630L375.84 630.07L375.84 630.15L375.84 630.22L375.84 630.29L375.84 630.36L375.84 630.43L375.84 630.49L375.84 630.55L375.84 630.61L375.84 630.67L375.84 630.72L375.84 630.77L375.84 630.81L375.84 630.85L375.84 630.89L375.84 630.92L375.84 630.95L375.84 630.97L375.84 630.99L375.84 631L375.84 631.01L375.84 631.02L375.84 631.02L375.84 631.01L375.84 631L375.84 630.98L375.84 630.95L375.84 630.92L375.84 630.89L375.84 630.84L375.84 630.79L375.84 630.74L375.84 630.67L375.84 630.6L375.84 630.52L375.84 630.44L375.84 630.34L375.84 616.2L375.84 616.1L375.84 616L375.84 615.9L375.84 615.79L375.84 615.68L375.84 615.57L375.84 615.46L375.84 615.34L375.84 615.22L375.84 615.11L375.84 614.98L375.84 614.86L375.84 614.74L375.84 614.61L375.84 614.48L375.84 614.35L375.84 614.22L375.84 614.08L375.84 613.95L375.84 613.81L375.84 613.68L375.84 613.54L375.84 613.4L375.84 613.26L375.84 613.11L375.84 612.97L375.84 612.83L375.84 612.68L375.84 612.54L375.84 612.39L375.84 612.24L375.84 612.09L375.84 611.95L375.84 611.8L375.84 611.65L375.84 611.5L375.84 611.35L375.84 611.2L375.84 611.05L375.84 610.9L375.84 601.2L375.84 600.98L375.84 599.1L375.84 597.18L375.84 595.21L375.84 593.21L375.84 592.31L375.84 589.43L375.84 589.38L375.84 589.34L375.84 589.3L375.84 589.25L375.84 589.2L375.84 589.15L375.84 589.1L375.84 589.05L375.84 589L375.84 588.94L375.84 588.88L375.84 588.82L375.84 588.75L375.84 588.69L375.84 588.62L375.84 588.55L375.84 588.48L375.84 588.4L375.84 588.33L375.84 588.25L375.84 588.17L375.84 588.08L375.84 588L375.84 587.91L375.84 587.81L375.84 587.72L375.84 587.62L375.84 587.52L375.84 587.42L375.84 587.31L375.84 587.21L375.84 587.09L375.84 586.98L375.84 586.86L375.84 586.74L375.84 586.62L375.84 586.49L375.84 586.36L375.84 586.23L375.84 586.09L375.84 566.09L375.84 565.96L375.84 565.82L375.84 565.7L375.84 565.57L375.84 565.45L375.84 565.33L375.84 565.22L375.84 565.11L375.84 565L375.84 564.9L375.84 564.8L375.84 564.7L375.84 564.61L375.84 564.52L375.84 564.43L375.84 564.34L375.84 564.25L375.84 564.17L375.84 564.09L375.84 564.02L375.84 563.94L375.84 563.87L375.84 563.79L375.84 563.72L375.84 563.66L375.84 563.59L375.84 563.52L375.84 563.46L375.84 563.4L375.84 563.34L375.84 563.28L375.84 563.22L375.84 563.16L375.84 563.1L375.84 563.04L375.84 562.98L375.84 562.93L375.84 562.87L375.84 562.81L375.84 562.76L375.84 559.88L375.84 558.97L375.84 556.97L375.84 555.01L375.84 553.08L375.84 551.2L375.84 551.01L375.84 541.33L375.84 541.18L375.84 541.03L375.84 540.88L375.84 540.73L375.84 540.58L375.84 540.43L375.84 540.28L375.84 540.13L375.84 539.98L375.84 539.84L375.84 539.69L375.84 539.54L375.84 539.4L375.84 539.25L375.84 539.11L375.84 538.97L375.84 538.83L375.84 538.69L375.84 538.55L375.84 538.41L375.84 538.27L375.84 538.14L375.84 538.01L375.84 537.87L375.84 537.74L375.84 537.62L375.84 537.49L375.84 537.36L375.84 537.24L375.84 537.12L375.84 537L375.84 536.88L375.84 536.77L375.84 536.65L375.84 536.54L375.84 536.43L375.84 536.33L375.84 536.22L375.84 536.12L375.84 536.02L375.84 521.88L375.84 521.79L375.84 521.7L375.84 521.62L375.84 521.55L375.84 521.49L375.84 521.43L375.84 521.38L375.84 521.34L375.84 521.3L375.84 521.27L375.84 521.24L375.84 521.23L375.84 521.21L375.84 521.21L375.84 521.21L375.84 521.21L375.84 521.22L375.84 521.23L375.84 521.25L375.84 521.28L375.84 521.3L375.84 521.34L375.84 521.37L375.84 521.41L375.84 521.46L375.84 521.51L375.84 521.56L375.84 521.61L375.84 521.67L375.84 521.73L375.84 521.8L375.84 521.86L375.84 521.93L375.84 522L375.84 522.08L375.84 522.15L375.84 522.23L375.84 522.31L375.84 522.39L375.84 522.47L375.84 528.08L375.84 527.97L375.84 527.04L375.84 526.18L375.84 525.4L375.84 524.69L375.84 524.41L375.84 513.59L375.84 513.42L375.84 513.25L375.84 513.08L375.84 512.92L375.84 512.75L375.84 512.59L375.84 512.43L375.84 512.28L375.84 512.12L375.84 511.97L375.84 511.82L375.84 511.68L375.84 511.54L375.84 511.4L375.84 511.26L375.84 511.13L375.84 511L375.84 510.88L375.84 510.76L375.84 510.65L375.84 510.54L375.84 510.43L375.84 510.33L375.84 510.23L375.84 510.14L375.84 510.05L375.84 509.97L375.84 509.89L375.84 509.82L375.84 509.75L375.84 509.69L375.84 509.64L375.84 509.59L375.84 509.55L375.84 509.51L375.84 509.48L375.84 509.46L375.84 509.44L375.84 509.43L375.84 509.43L375.84 509.43L375.84 509.43L375.84 509.44L375.84 509.46L375.84 509.48L375.84 509.51L375.84 509.55L375.84 509.59L375.84 509.64L375.84 509.69L375.84 509.75L375.84 509.82L375.84 509.89L375.84 509.97L375.84 510.05L375.84 510.14L375.84 510.23L375.84 510.33L375.84 510.43L375.84 510.54L375.84 510.65L375.84 510.76L375.84 510.88L375.84 511L375.84 511.13L375.84 511.26L375.84 511.4L375.84 511.54L375.84 511.68L375.84 511.82L375.84 511.97L375.84 512.12L375.84 512.28L375.84 512.43L375.84 512.59L375.84 512.75L375.84 512.92L375.84 513.08L375.84 513.25L375.84 513.42L375.84 513.59L375.84 524.41L375.84 524.69L375.84 525.4L375.84 526.18L375.84 527.04L375.84 527.97L375.84 528.09L375.84 522.51L375.84 522.42L375.84 522.33L375.84 522.24L375.84 522.15L375.84 522.07L375.84 521.99L375.84 521.92L375.84 521.84L375.84 521.77L375.84 521.71L375.84 521.64L375.84 521.59L375.84 521.53L375.84 521.48L375.84 521.43L375.84 521.39L375.84 521.35L375.84 521.31L375.84 521.28L375.84 521.26L375.84 521.24L375.84 521.22L375.84 521.21L375.84 521.21L375.84 521.21L375.84 521.21L375.84 521.22L375.84 521.24L375.84 521.26L375.84 521.29L375.84 521.32L375.84 521.36L375.84 521.41L375.84 521.46L375.84 521.52L375.84 521.59L375.84 521.66L375.84 521.74L375.84 521.83L375.84 521.92L375.84 536.06L375.84 536.16L375.84 536.26L375.84 536.36L375.84 536.47L375.84 536.58L375.84 536.68L375.84 536.79L375.84 536.91L375.84 537.02L375.84 537.14L375.84 537.25L375.84 537.37L375.84 537.5L375.84 537.62L375.84 537.74L375.84 537.87L375.84 538L375.84 538.13L375.84 538.26L375.84 538.39L375.84 538.53L375.84 538.67L375.84 538.8L375.84 538.94L375.84 539.08L375.84 539.23L375.84 539.37L375.84 539.52L375.84 539.66L375.84 539.81L375.84 539.96L375.84 540.11L375.84 540.26L375.84 540.42L375.84 540.57L375.84 540.73L375.84 540.89L375.84 541.04L375.84 541.2L375.84 541.37L375.84 551.03L375.84 551.2L375.84 553.08L375.84 555.01L375.84 556.97L375.84 558.97L375.84 559.88L375.84 562.76L375.84 562.81L375.84 562.87L375.84 562.93L375.84 562.98L375.84 563.04L375.84 563.1L375.84 563.16L375.84 563.22L375.84 563.28L375.84 563.34L375.84 563.4L375.84 563.46L375.84 563.52L375.84 563.59L375.84 563.66L375.84 563.72L375.84 563.79L375.84 563.87L375.84 563.94L375.84 564.02L375.84 564.09L375.84 564.17L375.84 564.25L375.84 564.34L375.84 564.43L375.84 564.52L375.84 564.61L375.84 564.7L375.84 564.8L375.84 564.9L375.84 565L375.84 565.11L375.84 565.22L375.84 565.33L375.84 565.45L375.84 565.57L375.84 565.7L375.84 565.82L375.84 565.96L375.84 566.09L375.84 586.09L375.84 586.23L375.84 586.36L375.84 586.49L375.84 586.62L375.84 586.74L375.84 586.86L375.84 586.98L375.84 587.09L375.84 587.21L375.84 587.31L375.84 587.42L375.84 587.52L375.84 587.62L375.84 587.72L375.84 587.81L375.84 587.91L375.84 588L375.84 588.08L375.84 588.17L375.84 588.25L375.84 588.33L375.84 588.4L375.84 588.48L375.84 588.55L375.84 588.62L375.84 588.69L375.84 588.75L375.84 588.82L375.84 588.88L375.84 588.94L375.84 589L375.84 589.05L375.84 589.1L375.84 589.15L375.84 589.2L375.84 589.25L375.84 589.3L375.84 589.34L375.84 589.38L375.84 589.43L375.84 592.31L375.84 593.21L375.84 595.21L375.84 597.18L375.84 599.1L375.84 600.98L375.84 601.17L375.84 610.86L375.84 611.02L375.84 611.18L375.84 611.34L375.84 611.49L375.84 611.65L375.84 611.81L375.84 611.96L375.84 612.11L375.84 612.26L375.84 612.41L375.84 612.56L375.84 612.71L375.84 612.85L375.84 613L375.84 613.14L375.84 613.28L375.84 613.42L375.84 613.56L375.84 613.69L375.84 613.83L375.84 613.96L375.84 614.09L375.84 614.22L375.84 614.35L375.84 614.48L375.84 614.6L375.84 614.73L375.84 614.85L375.84 614.97L375.84 615.09L375.84 615.2L375.84 615.32L375.84 615.43L375.84 615.54L375.84 615.65L375.84 615.75L375.84 615.86L375.84 615.96L375.84 616.06L375.84 616.16L375.84 630.3L375.84 630.4L375.84 630.48L375.84 630.56L375.84 630.64L375.84 630.7L375.84 630.76L375.84 630.82L375.84 630.86L375.84 630.9L375.84 630.94L375.84 630.96L375.84 630.99L375.84 631L375.84 631.01L375.84 631.02L375.84 631.02L375.84 631.01L375.84 631L375.84 630.99L375.84 630.97L375.84 630.94L375.84 630.91L375.84 630.87L375.84 630.84L375.84 630.79L375.84 630.75L375.84 630.69L375.84 630.64L375.84 630.58L375.84 630.52L375.84 630.45L375.84 630.38L375.84 630.31L375.84 630.23L375.84 630.15L375.84 630.07L375.84 629.98L375.84 629.9L375.84 629.81L375.84 629.71L375.84 624.11L375.84 624.21L375.84 625.14L375.84 626L375.84 626.79L375.84 627.5L375.84 627.78L375.84 638.59L375.84 638.76L375.84 638.93L375.84 639.1L375.84 639.27L375.84 639.43L375.84 639.59L375.84 639.75L375.84 639.91L375.84 640.06L375.84 640.21L375.84 640.36L375.84 640.51L375.84 640.65L375.84 640.79L375.84 640.92L375.84 641.05L375.84 641.18L375.84 641.3L375.84 641.42L375.84 641.54L375.84 641.65L375.84 641.76L375.84 641.86L375.84 641.95L375.84 642.05L375.84 642.13L375.84 642.22L375.84 642.29L375.84 642.36L375.84 642.43L375.84 642.49L375.84 642.55L375.84 642.59L375.84 642.64L375.84 642.67L375.84 642.7L375.84 642.73L375.84 642.74L375.84 642.76L375.84 642.76L375.84 642.76L375.84 642.76L375.84 642.74ZM375.84 605.16L375.84 605.04L375.84 604.88L375.84 604.67L375.84 604.41L375.84 604.11L375.84 603.77L375.84 603.39L375.84 602.97L375.84 602.5L375.84 602L375.84 601.46L375.84 600.89L375.84 600.28L375.84 599.63L375.84 598.95L375.84 598.24L375.84 597.49L375.84 596.72L375.84 595.91L375.84 595.07L375.84 594.21L375.84 593.32L375.84 592.4L375.84 591.46L375.84 590.49L375.84 589.5L375.84 588.48L375.84 587.44L375.84 586.39L375.84 585.31L375.84 584.21L375.84 583.1L375.84 581.97L375.84 580.82L375.84 579.66L375.84 578.48L375.84 577.29L375.84 576.09L375.84 574.89L375.84 573.7L375.84 572.52L375.84 571.36L375.84 570.21L375.84 569.08L375.84 567.97L375.84 566.87L375.84 565.8L375.84 564.74L375.84 563.7L375.84 562.69L375.84 561.7L375.84 560.73L375.84 559.78L375.84 558.87L375.84 557.97L375.84 557.11L375.84 556.27L375.84 555.47L375.84 554.69L375.84 553.95L375.84 553.23L375.84 552.55L375.84 551.91L375.84 551.3L375.84 550.72L375.84 550.18L375.84 549.68L375.84 549.22L375.84 548.79L375.84 548.41L375.84 548.07L375.84 547.77L375.84 547.52L375.84 547.31L375.84 547.14L375.84 547.02L375.84 546.95L375.84 546.93L375.84 546.95L375.84 547.02L375.84 547.14L375.84 547.31L375.84 547.52L375.84 547.77L375.84 548.07L375.84 548.41L375.84 548.79L375.84 549.22L375.84 549.68L375.84 550.18L375.84 550.72L375.84 551.3L375.84 551.91L375.84 552.55L375.84 553.23L375.84 553.95L375.84 554.69L375.84 555.47L375.84 556.27L375.84 557.11L375.84 557.97L375.84 558.87L375.84 559.78L375.84 560.73L375.84 561.7L375.84 562.69L375.84 563.7L375.84 564.74L375.84 565.8L375.84 566.87L375.84 567.97L375.84 569.08L375.84 570.21L375.84 571.36L375.84 572.52L375.84 573.7L375.84 574.89L375.84 576.09L375.84 577.29L375.84 578.48L375.84 579.66L375.84 580.82L375.84 581.97L375.84 583.1L375.84 584.21L375.84 585.31L375.84 586.39L375.84 587.44L375.84 588.48L375.84 589.5L375.84 590.49L375.84 591.46L375.84 592.4L375.84 593.32L375.84 594.21L375.84 595.07L375.84 595.91L375.84 596.72L375.84 597.49L375.84 598.24L375.84 598.95L375.84 599.63L375.84 600.28L375.84 600.89L375.84 601.46L375.84 602L375.84 602.5L375.84 602.97L375.84 603.39L375.84 603.77L375.84 604.11L375.84 604.41L375.84 604.67L375.84 604.88L375.84 605.04L375.84 605.16L375.84 605.23L375.84 605.26L375.84 605.23L375.84 605.16Z" id="cumNXa6PC"></path></defs><g><g><g><use xlink:href="#b4JGhtaG" opacity="1" fill="#f08705" fill-opacity="1"></use><g><use xlink:href="#b4JGhtaG" opacity="1" fill-opacity="0" stroke="#000000" stroke-width="1" stroke-opacity="0"></use></g></g><g><use xlink:href="#a56pjqCsSe" opacity="1" fill="#ffffff" fill-opacity="1"></use><g><use xlink:href="#a56pjqCsSe" opacity="1" fill-opacity="0" stroke="#000000" stroke-width="1" stroke-opacity="0"></use></g></g><g><use xlink:href="#cumNXa6PC" opacity="1" fill="#5219b9" fill-opacity="1"></use></g></g></g></svg>`

function generateRandomModalid(length) {
	return Array(length).fill(0).map(x => Math.random().toString(36).charAt(2)).join('')
}

function getDrawingEditor() {
	iframe = document.createElement('iframe');
	iframe.setAttribute('frameborder', '0');
	window.addEventListener('message', drawReceive);
	iframe.setAttribute('src', drawIoUrl);
	iframe.setAttribute('class', 'fullscreen');
	return iframe
}

function addModal() {
	const randomChars = generateRandomModalid()

	let wrapperDiv = document.createElement("div");
	wrapperDiv.setAttribute("class", "modal micromodal-slide");
	wrapperDiv.setAttribute("id", `drawio-modal-${randomChars}`);

	let overlayDiv = document.createElement("div");
	overlayDiv.setAttribute("class", "modal__overlay");
	overlayDiv.setAttribute("data-micromodal-close", "1"); // Dont close on click outside

	let modalContainerDiv = document.createElement("div");
	modalContainerDiv.setAttribute("class", "modal__container");
	modalContainerDiv.setAttribute("role", "dialog");
	modalContainerDiv.setAttribute("aria-modal", "true");

	let modalMainDiv = document.createElement("main");
	modalMainDiv.setAttribute("id", "modal-main-1");


	modalContainerDiv.appendChild(modalMainDiv);
	overlayDiv.appendChild(modalContainerDiv);
	wrapperDiv.appendChild(overlayDiv);

	document.body.appendChild(wrapperDiv);


	MicroModal.show(`drawio-modal-${randomChars}`, {
		onShow: modal => {
			console.info('opening Draw.io')
			modalDiv = document.getElementById(modal.id)
			let drawio_iframe = getDrawingEditor();
			modalDiv.appendChild(drawio_iframe)
		},
  		onClose: modal => {
			console.info('closing Draw.io')
			modalDiv = document.getElementById(modal.id)
			document.body.removeChild(modalDiv)
		},
	});
}

function addGitlabIssueToolbarsBtn() {
	let toolbars = document.querySelectorAll("div.md-write-holder")
	for(let toolbar of toolbars) {
		let commentHolder = toolbar.getElementsByClassName('comment-toolbar')[0]
		if(commentHolder && (commentHolder.getElementsByClassName('drawio-modal-btn').length == 0)) {
			let _drawioBtnId = `drawio-modal-btn-${getRandomString()}`;
			let buttonSelector = document.createElement("button");
			buttonSelector.setAttribute("class", "toolbar-btn js-md has-tooltip drawio-modal-btn");
			buttonSelector.setAttribute("id", _drawioBtnId);
			buttonSelector.setAttribute("data-container", "body");
			buttonSelector.setAttribute("title", "Add drawio");
			buttonSelector.setAttribute("aria-label", "Add drawio");
			buttonSelector.innerHTML = svgIcon;

			buttonSelector.addEventListener("click", clickHandler, false)

			commentHolder.appendChild(buttonSelector)
		}
	}
}

function clickHandler(event) {
	event.preventDefault();
	event.stopPropagation();
	addModal();
	drawioBtnId = this.getAttribute('id');
}

function b64DecodeUnicode(str) {
	str = str.split(';base64,')[1];
	// Going backwards: from bytestream, to percent-encoding, to original string.
	return decodeURIComponent(atob(str).split('').map(function(c) {
		return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
	}).join(''));
}

function getRandomString() {
	return Math.random().toString(36).slice(2)
}

function updateGitlabContent(svg) {

	let svgHtml = b64DecodeUnicode(svg);
	let imgBlob = new Blob([svgHtml], {type:"image/svg+xml;charset=utf-8"})
	let drawioFile = new File([imgBlob], `drawio-${getRandomString()}.svg`)

	var data = {
		svgfile: drawioFile,
		drawioTriggerid: drawioBtnId
	};

	document.dispatchEvent(new CustomEvent('GitlabDrawioCustomEvent', { detail: data }));
}

/**
 *
 * Drawio events handler
 */
function drawEventExport(message) {
	updateGitlabContent(message.data);

	if (modalDiv) {
		MicroModal.close(modalDiv.getAttribute("id"))
	}
}

function drawEventSave(message) {
	drawPostMessage({action: 'export', format: 'svg', xml: message.xml, spin: 'Updating drawing'});
}

function drawEventInit() {
	drawPostMessage({action: 'load', autosave: 1, xml: ''});
}

function drawEventClose() {
	window.removeEventListener('message', drawReceive);
	if (modalDiv) {
		MicroModal.close(modalDiv.getAttribute("id"))
		//document.body.removeChild(modal);
	}
}


function drawPostMessage(data) {
	iframe.contentWindow.postMessage(JSON.stringify(data), '*');
}

function drawReceive(event) {
	if (!event.data || event.data.length < 1) return;
	try {
		let message = JSON.parse(event.data);
		if (message.event === 'init') {
            drawEventInit();
        } else if (message.event === 'exit') {
            drawEventClose();
        } else if (message.event === 'save') {
            drawEventSave(message);
        } else if (message.event === 'export') {
            drawEventExport(message);
		}
	} catch(e) {
		console.error(e)
	}
}

// https://stackoverflow.com/a/9310273
function appendScript(callback)
{
	var s = document.createElement('script');
	s.src = chrome.runtime.getURL('drawio-receiver.js');
	s.onload = function() {
		this.remove();
		callback();
	};
	(document.head || document.documentElement).appendChild(s);
}

appendScript(() => addGitlabIssueToolbarsBtn())

chrome.extension.onMessage.addListener(function(msg, sender, sendResponse) {
	if (msg.action == 'open_drawio_box') {
		addGitlabIssueToolbarsBtn()
	}
});
